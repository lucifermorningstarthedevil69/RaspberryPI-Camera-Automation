<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test History</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .main-container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            flex-grow: 1;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3a3a3c;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .header h1 {
            font-size: 24px;
            margin: 0;
        }
        .nav a {
            color: #8e8e93;
            text-decoration: none;
            margin-left: 20px;
            font-size: 16px;
        }
        .nav a.active {
            color: #ffffff;
            border-bottom: 2px solid #007aff;
            padding-bottom: 5px;
        }
        .card {
            background-color: #2c2c2e;
            border-radius: 12px;
            padding: 20px;
        }
        .card h2 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 20px;
            color: #8e8e93;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #3a3a3c;
        }
        th {
            font-size: 14px;
            color: #8e8e93;
            text-transform: uppercase;
        }
        .status-Pass { color: #4cd964; }
        .status-Fail { color: #ff3b30; }
        .status-Running { color: #ff9500; }
        .footer {
            text-align: center;
            padding: 20px;
            font-size: 12px;
            color: #8e8e93;
            border-top: 1px solid #3a3a3c;
            margin-top: 20px;
        }
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 5px;
        }
        .btn[disabled] {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-view { background-color: #007aff; color: #fff; }
        .btn-download { background-color: #333; color: #fff; }
        .btn-delete { background-color: #ff3b30; color: #fff; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>Test Damage to Conductor</h1>
            <nav class="nav">
                <a href="/">Home</a>
                <a href="/history" class="active">Test History</a>
                <a href="/system-info">System Info</a>
            </nav>
        </div>

        <div class="card">
            <h2>Test Logs</h2>
            <table>
                <thead>
                    <tr>
                        <th>Time & Date</th>
                        <th>Sample Code</th>
                        <th>Set Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="log-table-body">
                    <!-- Log rows will be inserted here dynamically -->
                </tbody>
            </table>
        </div>
    </div>
    <footer class="footer">
        Copyright Â© 2024 Cenduetice. | Contact Us | Privacy Policy
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', fetchLogs);

        const logTableBody = document.getElementById('log-table-body');

        async function fetchLogs() {
            try {
                const response = await fetch('/api/test/logs');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const logs = await response.json();
                renderLogs(logs);
            } catch (error) {
                console.error("Failed to fetch logs:", error);
                logTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Error loading logs.</td></tr>`;
            }
        }

        function formatLogTime(isoString) {
            if (!isoString) return 'N/A';
            try {
                const d = new Date(isoString);
                const year = d.getFullYear();
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const day = d.getDate().toString().padStart(2, '0');
                const hours = d.getHours().toString().padStart(2, '0');
                const minutes = d.getMinutes().toString().padStart(2, '0');
                const seconds = d.getSeconds().toString().padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            } catch (e) {
                console.error("Could not format date:", isoString, e);
                return isoString; // Fallback to original string
            }
        }

        function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00:00";
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function getVideoFilename(log) {
            if (log.video_filename) return log.video_filename;
            if (log.video_path) {
                const parts = log.video_path.split('/');
                return parts[parts.length - 1];
            }
            return null;
        }

        function renderLogs(logs) {
            logTableBody.innerHTML = ''; 

            if (!logs || logs.length === 0) {
                logTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No test logs found.</td></tr>`;
                return;
            }

            logs.forEach(log => {
                const time = formatLogTime(log.time);
                const duration = formatDuration(log.duration);
                const videoFilename = getVideoFilename(log);
                const isVideoAvailable = videoFilename !== null;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${time}</td>
                    <td>${log.sample_code || 'N/A'}</td>
                    <td>${duration}</td>
                    <td class="status-${log.status}">${log.status || 'Unknown'}</td>
                    <td>
                        <button class="btn btn-view" data-filename="${videoFilename}" ${!isVideoAvailable ? 'disabled' : ''}>View</button>
                        <button class="btn btn-download" data-id="${log.id}" ${!isVideoAvailable ? 'disabled' : ''}>Download</button>
                        <button class="btn btn-delete" data-id="${log.id}">Delete</button>
                    </td>
                `;
                logTableBody.appendChild(row);
            });
        }

        logTableBody.addEventListener('click', async (event) => {
            const target = event.target.closest('button');
            if (!target) return;

            const logId = target.dataset.id;
            const filename = target.dataset.filename;

            if (target.classList.contains('btn-delete')) {
                if (confirm('Are you sure you want to delete this log and its video?')) {
                    await deleteLog(logId);
                }
            } else if (target.classList.contains('btn-download')) {
                if(logId) downloadPackage(logId);
            } else if (target.classList.contains('btn-view')) {
                if (filename && filename !== 'null') {
                    viewVideo(filename);
                }
            }
        });

        async function deleteLog(logId) {
            try {
                const response = await fetch(`/api/test/logs/${logId}`, { method: 'DELETE' });
                if (response.ok) {
                    fetchLogs(); // Refresh list
                } else {
                    const err = await response.json();
                    alert(`Failed to delete log: ${err.status}`);
                }
            } catch (error) {
                console.error("Error deleting log:", error);
                alert("An error occurred while deleting the log.");
            }
        }

        function downloadPackage(logId) {
            window.location.href = `/api/download/package/${logId}`;
        }

        function viewVideo(filename) {
            window.open(`/play/${filename}`, '_blank');
        }
    </script>
</body>
</html>
